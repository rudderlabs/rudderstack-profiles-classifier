# update for github
models:
  - name: Union_Event_Data
    model_type: sql_template
    model_spec:
      validity_time: 24h # 1 day
      materialization:
        output_type: ephemeral
        run_type: discrete
      single_sql: |
        {% with Pages = this.DeRef("inputs/mkt_pages") FormSubmit = this.DeRef("inputs/mkt_form_submit") Basin = this.DeRef("inputs/mkt_basin_and_sf_enrich") FormSubmitHistorical = this.DeRef("inputs/mkt_form_submit_historical") Identifies = this.DeRef("inputs/app_identifies") PagesHistorical = this.DeRef("inputs/mkt_pages_historical") SFLead = this.DeRef("inputs/sf_lead") Tracks = this.DeRef("inputs/app_tracks") %}
          select l.anonymous_id, l.context_traits_email, l.user_id, l.context_page_url, l.gclid, l.campaign, l.utm_source, l.utm_medium, l.utm_content, l.raid, l.context_page_initial_referrer, l.context_page_referrer, l.timestamp, l.event_text, l.event, l.event_source, l.account_type, case when l.form_id like 'app_signup%' then 'Webapp CTA' when l.form_id like 'signup_%' then 'Webapp CTA' when l.form_id like 'app_signup_mkt_site%' then 'Website CTA' when l.form_id like 'join_community%' then 'Website CTA' when l.form_id like 'contact_us%' then 'Website CTA' when l.form_id like 'request_demo%' then 'Website CTA' when l.form_id like 'enterprise_quote%' then 'Website CTA' when l.form_id like 'ebook%' then 'Website CTA' when l.form_id like 'live_webinar%' then 'Website CTA' when l.form_id like 'gated_webinar%' then 'Website CTA' when l.form_id like 'whitepaper%' then 'Website CTA' when l.form_id like 'video%' then 'Website CTA' when l.form_id like 'conference%' then 'Event' when l.form_id like 'field%' then 'Event' when l.form_id like 'networking%' then 'Event' when l.form_id like 'outbound%' then 'Website CTA' when l.form_id like 'hushly%' then 'Website CTA' when l.form_id like 'nethawk%' then 'Website CTA' when l.form_id like 'qualified%' then 'Website CTA' when l.form_id like 'blog subscription%' then 'Website CTA' when l.form_id like 'scratchershirt%' then 'Website CTA' when l.form_id like 'partnership%' then 'Website CTA' when l.form_id like 'office_hours%' then 'Website CTA' when l.form_id like 'learning_signup%' then 'Website CTA' when l.form_id like 'landing_page_signup%' then 'Website CTA' when l.form_id like 'guides_signup%' then 'Website CTA' when l.form_id like 'form_id%' then 'Other' when l.form_id like 'event_%' then 'Event' when l.form_id like 'demo_request%' then 'Website CTA' when l.form_id like 'blog%' then 'Website CTA' else mkt.conversion_type end as conversion_type, l.form_id, l.migration, l.spz_1, case when l.form_id like 'app_signup%' then 'App Signup Webapp' when l.form_id like 'signup_%' then 'App Signup Mkt Site' when l.form_id like 'app_signup_mkt_site%' then 'App Signup Webapp' when l.form_id like 'join_community%' then 'Join Slack Community' when l.form_id like 'contact_us%' then 'Contact Us' when l.form_id like 'request_demo%' then 'Request Demo' when l.form_id like 'enterprise_quote%' then 'Enterprise Quote' when l.form_id like 'ebook%' then 'Content Download' when l.form_id like 'live_webinar%' then 'Live Webinar' when l.form_id like 'gated_webinar%' then 'Gated Webinar' when l.form_id like 'whitepaper%' then 'Content Download' when l.form_id like 'video%' then 'Gated Webinar' when l.form_id like 'conference%' then 'Event Attended' when l.form_id like 'field%' then 'Event Attended' when l.form_id like 'networking%' then 'Event Attended' when l.form_id like 'outbound%' then 'Request Demo' when l.form_id like 'hushly%' then 'Content Download' when l.form_id like 'nethawk%' then 'Content Download' when l.form_id like 'qualified%' then 'Content Download' when l.form_id like 'blog subscription%' then 'Blog subscription' when l.form_id like 'scratchershirt%' then 'Shirt Giveaway' when l.form_id like 'partnership%' then 'Partnerships Request' when l.form_id like 'office_hours%' then 'Office Hours' when l.form_id like 'learning_signup%' then 'App Signup Webapp' when l.form_id like 'landing_page_signup%' then 'App Signup Webapp' when l.form_id like 'guides_signup%' then 'App Signup Webapp' when l.form_id like 'form_id%' then 'Other' when l.form_id like 'event_%' then 'Event Attended' when l.form_id like 'demo_request%' then 'Request Demo' when l.form_id like 'blog%' then 'Content Download' else mkt.conversion end as conversion, case when l.form_id like 'app_signup%' then 'App Signup' when l.form_id like 'signup_%' then 'App Signup' when l.form_id like 'app_signup_mkt_site%' then 'App Signup' when l.form_id like 'join_community%' then 'Other' when l.form_id like 'contact_us%' then 'Contact Us' when l.form_id like 'request_demo%' then 'Demo & Quote Request' when l.form_id like 'enterprise_quote%' then 'Demo & Quote Request' when l.form_id like 'ebook%' then 'Other' when l.form_id like 'live_webinar%' then 'Other' when l.form_id like 'gated_webinar%' then 'Other' when l.form_id like 'whitepaper%' then 'Other' when l.form_id like 'video%' then 'Other' when l.form_id like 'conference%' then 'Other' when l.form_id like 'field%' then 'Other' when l.form_id like 'networking%' then 'Other' when l.form_id like 'outbound%' then 'Demo & Quote Request' when l.form_id like 'hushly%' then 'Content Download' when l.form_id like 'nethawk%' then 'Content Download' when l.form_id like 'qualified%' then 'Chat' when l.form_id like 'blog subscription%' then 'Other' when l.form_id like 'blog subscription%' then 'Other' when l.form_id like 'scratchershirt%' then 'Other' when l.form_id like 'partnership%' then 'Other' when l.form_id like 'office_hours%' then 'Other' when l.form_id like 'learning_signup%' then 'App Signup' when l.form_id like 'landing_page_signup%' then 'App Signup' when l.form_id like 'guides_signup%' then 'App Signup' when l.form_id like 'form_id%' then 'Other' when l.form_id like 'event_%' then 'Other' when l.form_id like 'demo_request%' then 'Demo & Quote Request' when l.form_id like 'blog%' then 'Other' else mkt.conversion_category end as conversion_category, sf.company_domain_c, exc.exclude_reason, case when l.form_id like 'app_signup%' then 'Online' when l.form_id like 'signup_%' then 'Online' when l.form_id like 'app_signup_mkt_site%' then 'Online' when l.form_id like 'join_community%' then 'Online' when l.form_id like 'contact_us%' then 'Online' when l.form_id like 'request_demo%' then 'Online' when l.form_id like 'enterprise_quote%' then 'Online' when l.form_id like 'ebook%' then 'Online' when l.form_id like 'live_webinar%' then 'Online' when l.form_id like 'gated_webinar%' then 'Online' when l.form_id like 'whitepaper%' then 'Online' when l.form_id like 'video%' then 'Online' when l.form_id like 'conference%' then 'Offline' when l.form_id like 'field%' then 'Online' when l.form_id like 'networking%' then 'Online' when l.form_id like 'outbound%' then 'Online' when l.form_id like 'hushly%' then 'Online' when l.form_id like 'nethawk%' then 'Online' when l.form_id like 'qualified%' then 'Online' when l.form_id like 'blog subscription%' then 'Online' when l.form_id like 'scratchershirt%' then 'Online' when l.form_id like 'partnership%' then 'Online' when l.form_id like 'office_hours%' then 'Other' when l.form_id like 'learning_signup%' then 'Online' when l.form_id like 'landing_page_signup%' then 'Online' when l.form_id like 'guides_signup%' then 'Online' when l.form_id like 'form_id%' then 'Other' when l.form_id like 'event_%' then 'Online' when l.form_id like 'demo_request%' then 'Online' when l.form_id like 'blog%' then 'Online' else 'Other' end as online_offline_conversion, case when l.form_id like 'app_signup%' then 'Inbound' when l.form_id like 'signup_%' then 'Inbound' when l.form_id like 'app_signup_mkt_site%' then 'Inbound' when l.form_id like 'join_community%' then 'Inbound' when l.form_id like 'contact_us%' then 'Inbound' when l.form_id like 'request_demo%' then 'Inbound' when l.form_id like 'enterprise_quote%' then 'Inbound' when l.form_id like 'ebook%' then 'Inbound' when l.form_id like 'live_webinar%' then 'Inbound' when l.form_id like 'gated_webinar%' then 'Inbound' when l.form_id like 'whitepaper%' then 'Inbound' when l.form_id like 'video%' then 'Inbound' when l.form_id like 'conference%' then 'Field' when l.form_id like 'field%' then 'Field' when l.form_id like 'networking%' then 'Field' when l.form_id like 'outbound%' then 'Outbound' when l.form_id like 'hushly%' then 'Inbound' when l.form_id like 'nethawk%' then 'Inbound' when l.form_id like 'qualified%' then 'Inbound' when l.form_id like 'blog subscription%' then 'Inbound' when l.form_id like 'scratchershirt%' then 'Inbound' when l.form_id like 'partnership%' then 'Inbound' when l.form_id like 'office_hours%' then 'Other' when l.form_id like 'learning_signup%' then 'Inbound' when l.form_id like 'landing_page_signup%' then 'Inbound' when l.form_id like 'guides_signup%' then 'Inbound' when l.form_id like 'form_id%' then 'Other' when l.form_id like 'event_%' then 'Field' when l.form_id like 'demo_request%' then 'Inbound' when l.form_id like 'blog%' then 'Inbound' else 'Other' end as conversion_function, l.channel, l.session_referrer, l.session_source_medium, l.session_utm_medium, l.session_utm_source, l.context_session_id, l.mutiny_visitor, l.mutiny_experience  from (
          select p.anonymous_id, lower(context_traits_email) as context_traits_email, user_id, context_page_url, split_part(split_part(context_page_url, 'utm_campaign=', 2), '&', 1) as campaign, split_part(split_part(context_page_url, 'utm_source=', 2), '&', 1) as utm_source, split_part(split_part(context_page_url, 'utm_medium=', 2), '&', 1) as utm_medium, split_part(split_part(context_page_url, 'utm_content=', 2), '&', 1) as utm_content, split_part(split_part(context_page_url, 'raid=', 2), '&', 1) as raid, context_page_initial_referrer, context_page_referrer, p.timestamp, null::text as event_text, 'Page' as event, 'Main Site' as event_source, null::text as account_type, null::text as conversion_type, null::text as form_id, null::text as migration, context_traits_spz_1 as spz_1, split_part(split_part(context_page_url,'gclid=',2),'&',1) as gclid, s.channel, s.referrer as session_referrer, s.source_medium as session_source_medium, s.utm_medium as session_utm_medium, s.utm_source as session_utm_source, s.context_session_id, null as mutiny_experience, null as mutiny_visitor from {{Pages}} p left join analytics_db.webanalytics.rs_stg_all_events s on s.anonymous_id = p.anonymous_id and s.timestamp = p.timestamp
          union all
          select anonymous_id, lower(context_traits_email) as context_traits_email, user_id, context_page_url, split_part(split_part(context_page_url, 'utm_campaign=', 2), '&', 1) as campaign, split_part(split_part(context_page_url, 'utm_source=', 2), '&', 1) as utm_source, split_part(split_part(context_page_url, 'utm_medium=', 2), '&', 1) as utm_medium, split_part(split_part(context_page_url, 'utm_content=', 2), '&', 1) as utm_content, split_part(split_part(context_page_url, 'raid=', 2), '&', 1) as raid, context_page_initial_referrer, context_page_referrer, timestamp, event_text, event, 'Main Site' as event_source, null::text as account_type, 'form_submit' as conversion_type, form_id, null::text as migration, context_traits_spz_1 as spz_1, split_part(split_part(context_page_url,'gclid=',2),'&',1) as gclid, Null as channel, null as session_referrer, null as session_source_medium, null as session_utm_medium, null as session_utm_source, null as context_session_id, MUTINY_EXPERIENCES as mutiny_experience, MUTINY_VISITOR_DATA_QUERY_UTM_SOURCE as mutiny_visitor from {{FormSubmit}}
          union all
          select anonymous_id, lower(email) as context_traits_email, lower(email) as user_id, page_url as context_page_url, utm_campaign as campaign, utm_source, utm_medium, utm_content, raid, null as context_page_initial_referrer, null as context_page_referrer, timestamp, event_text, event, 'Main Site' as event_source, null::text as account_type, 'form_submit' as conversion_type, coalesce(form_id, 'wf-form-CTAPage-body-JoinCommunity-form') as form_id, null::text as migration, spz_1, split_part(split_part(context_page_url,'gclid=',2),'&',1) as gclid, Null as channel, null as session_referrer, null as session_source_medium, null as session_utm_medium, null as session_utm_source, null as context_session_id, MUTINY_EXPERIENCES as mutiny_experience, MUTINY_VISITOR_DATA_QUERY_UTM_SOURCE as mutiny_visitor from {{Basin}}
          union all
          select anonymous_id, lower(context_traits_email) as context_traits_email, user_id, context_page_url, split_part(split_part(context_page_url, 'utm_campaign=', 2), '&', 1) as campaign, split_part(split_part(context_page_url, 'utm_source=', 2), '&', 1) as utm_source, split_part(split_part(context_page_url, 'utm_medium=', 2), '&', 1) as utm_medium, split_part(split_part(context_page_url, 'utm_content=', 2), '&', 1) as utm_content, split_part(split_part(context_page_url, 'raid=', 2), '&', 1) as raid, context_page_initial_referrer, context_page_referrer, timestamp, event_text, event, 'Marketing Site Webflow' as event_source, null::text as account_type, 'form_submit' as conversion_type, form_id, null::text as migration, null as spz_1, split_part(split_part(context_page_url,'gclid=',2),'&',1) as gclid, Null as channel, null as session_referrer, null as session_source_medium, null as session_utm_medium, null as session_utm_source, null as context_session_id, null as mutiny_experience, null as mutiny_visitor from {{FormSubmitHistorical}}
          union all
          select i.anonymous_id, case when lower(context_traits_email) like '%@%' THEN context_traits_email when user_id like '%@%' THEN user_id else context_traits_email end as context_traits_email, case when lower(context_traits_email) like '%@%' THEN context_traits_email when user_id like '%@%' THEN user_id else context_traits_email end as user_id, coalesce(context_page_url, 'https://app.rudderstack') as context_page_url, split_part(split_part(context_page_url, 'utm_campaign=', 2), '&', 1) as campaign, split_part(split_part(context_page_url, 'utm_source=', 2), '&', 1) as utm_source, split_part(split_part(context_page_url, 'utm_medium=', 2), '&', 1) as utm_medium, split_part(split_part(context_page_url, 'utm_content=', 2), '&', 1) as utm_content, split_part(split_part(context_page_url, 'raid=', 2), '&', 1) as raid, context_page_initial_referrer, context_page_referrer, i.timestamp, case when first_login = true or context_library_name = 'analytics-node' then 'First Login' else null end as event_text, 'Identify' as event, 'Web App' as event_source, account_type, 'user_signed_up' as conversion_type, context_traits_form_id as form_id, migration, null as spz_1, split_part(split_part(context_page_url,'gclid=',2),'&',1) as gclid, s.channel, s.referrer as session_referrer, s.source_medium as session_source_medium, s.utm_medium as session_utm_medium, s.utm_source as session_utm_source, s.context_session_id, null as mutiny_experience, null as mutiny_visitor from {{Identifies}} i left join analytics_db.webanalytics.rs_stg_all_events s on s.anonymous_id = i.anonymous_id and s.timestamp = i.timestamp
          union all
          select anonymous_id, lower(context_traits_email) as context_traits_email, user_id, context_page_url, split_part(split_part(context_page_url, 'utm_campaign=', 2), '&', 1) as campaign, split_part(split_part(context_page_url, 'utm_source=', 2), '&', 1) as utm_source, split_part(split_part(context_page_url, 'utm_medium=', 2), '&', 1) as utm_medium, split_part(split_part(context_page_url, 'utm_content=', 2), '&', 1) as utm_content, split_part(split_part(context_page_url, 'raid=', 2), '&', 1) as raid, context_page_initial_referrer, context_page_referrer, null as timestamp, 'Page' as event_text, 'Page' as event, 'Documentation' as event_source, null as account_type, null as conversion_type, null as form_id, null::text as migration, null as spz_1, split_part(split_part(context_page_url,'gclid=',2),'&',1) as gclid, Null as channel, null as session_referrer, null as session_source_medium, null as session_utm_medium, null as session_utm_source, null as context_session_id, null as mutiny_experience, null as mutiny_visitor from {{PagesHistorical}}
          union all
          select t.anonymous_id, lower(context_traits_email) as context_traits_email, user_id, context_page_url, split_part(split_part(context_page_url, 'utm_campaign=', 2), '&', 1) as campaign, split_part(split_part(context_page_url, 'utm_source=', 2), '&', 1) as utm_source, split_part(split_part(context_page_url, 'utm_medium=', 2), '&', 1) as utm_medium, split_part(split_part(context_page_url, 'utm_content=', 2), '&', 1) as utm_content, split_part(split_part(context_page_url, 'raid=', 2), '&', 1) as raid, context_page_initial_referrer, context_page_referrer, t.timestamp, 'Tracks' as event_text, 'Tracks' as event, 'Tracks' as event_source, null as account_type, null as conversion_type, null as form_id, null::text as migration, null as spz_1, null as gclid, s.channel, s.referrer as session_referrer, s.source_medium as session_source_medium, s.utm_medium as session_utm_medium, s.utm_source as session_utm_source, s.context_session_id, null as mutiny_experience, null as mutiny_visitor from {{Tracks}} t left join analytics_db.webanalytics.rs_stg_all_events s on s.anonymous_id = t.anonymous_id and s.timestamp = t.timestamp
          union all
          select anonymous_id, lower(context_traits_email) as context_traits_email, user_id, context_page_url, split_part(split_part(context_page_url, 'utm_campaign=', 2), '&', 1) as campaign, split_part(split_part(context_page_url, 'utm_source=', 2), '&', 1) as utm_source, split_part(split_part(context_page_url, 'utm_medium=', 2), '&', 1) as utm_medium, split_part(split_part(context_page_url, 'utm_content=', 2), '&', 1) as utm_content, split_part(split_part(context_page_url, 'raid=', 2), '&', 1) as raid, context_page_initial_referrer, context_page_referrer, null as timestamp, 'Page' as event_text, 'Page' as event, 'Documentation' as event_source, null as account_type, null as conversion_type, null as form_id, null::text as migration, null as spz_1, split_part(split_part(context_page_url,'gclid=',2),'&',1) as gclid, Null as channel, null as session_referrer, null as session_source_medium, null as session_utm_medium, null as session_utm_source, null as context_session_id, null as mutiny_experience, null as mutiny_visitor from {{PagesHistorical}}
          union all
          select coalesce(ec.anonymous_id, mb.anonymous_id) as anonymous_id, coalesce(ec.field_values_email, mb.field_values_email) as field_values_email, coalesce(ec.user_id, mb.user_id) as user_id, coalesce(ec.context_page_url, mb.context_page_url) as context_page_url, coalesce(ec.field_values_utm_campaign, mb.field_values_utm_campaign) as utm_campaign, coalesce(ec.field_values_utm_source, mb.field_values_utm_source) as utm_source, coalesce(ec.field_values_utm_medium, mb.field_values_utm_medium) as utm_medium, coalesce(ec.field_values_utm_content, mb.field_values_utm_content) as utm_content, coalesce(ec.field_values_raid, mb.field_values_raid) as raid, coalesce(ec.context_page_initial_referrer, mb.context_page_initial_referrer) as context_page_initial_referrer, coalesce(ec.context_page_referrer, mb.context_page_referrer) as context_page_referrer, coalesce(ec.timestamp, mb.timestamp) as timestamp, coalesce(ec.event_text, mb.event_text) as event_text, coalesce(ec.event, mb.event) as event, 'qualified' as event_source, null as account_type, null as conversion_type, coalesce(ec.context_traits_form_id, mb.context_traits_form_id) as form_id, coalesce(ec.context_traits_migration, mb.context_traits_migration) as migration, null as spz1, coalesce(ec.context_traits_gclid, mb.context_traits_gclid) as gclid, coalesce(ec.channel, mb.channel) as channel, null as session_referrer, null as session_source_medium, null as session_utm_medium, null as session_utm_source, null as context_session_id, null as mutiny_experience, null as mutiny_visitor from rudder_autotrack_data.autotrack.email_captured ec full outer join rudder_autotrack_data.autotrack.meeting_booked mb on ec.field_values_email = mb.field_values_email          
          union all
          select null as anonymous_id, lower(email) as context_traits_email, lower(email) as user_id, conversion_page_url_c as context_page_url, utm_campaign_c as campaign, UTM_source_c as utm_source, utm_medium_c as utm_medium, utm_content_c  as utm_content, raid_c as raid, null as context_page_initial_referrer, null as context_page_referrer, created_date as timestamp, event_text, event, 'Salesforce Lead' as event_source, null::text as account_type, null as conversion_type, form_id_c as form_id, null::text as migration, null as spz_1, GCLID_C as gclid, Null as channel, null as session_referrer, null as session_source_medium, null as session_utm_medium, null as session_utm_source, null as context_session_id, null as mutiny_experience, null as mutiny_visitor from {{SFLead}}) l left outer join eric_db.eric_data.mkt_conversions_rows mkt on l.form_id = mkt.form_id left join common.public.sf_lead sf on lower(sf.email) = l.context_traits_email left join (select lower(email) as email, exclude_reason from eric_db.eric_data.email_exclusion_list_rows where context_sources_job_run_id = (select top 1 context_sources_job_run_id from eric_db.eric_data.email_exclusion_list_rows order by timestamp desc)) exc on lower(exc.email) = l.context_traits_email
        {% endwith %}
      ids:
        - select: "user_id"
          type: user_id
          entity: user
          to_default_stitcher: false
        - select: "anonymous_id"
          type: anonymous_id
          entity: user
          to_default_stitcher: false
        - select: "context_traits_email"
          type: email
          entity: user
          to_default_stitcher: false
      contract:
        is_optional: false
        is_event_stream: false
        with_entity_ids:
          - user
        with_columns:
          - name: user_id
          - name: anonymous_id
          - name: context_traits_email
  - name: Account_Rank
    model_type: sql_template
    model_spec:
      validity_time: 24h # 1 day
      materialization:
        output_type: ephemeral
        run_type: discrete
      single_sql: |
        {% set Union = this.DeRef("models/Union_Event_Data")%}
        select company_domain_c, context_traits_email, timestamp, row_number() over (partition by company_domain_c order by timestamp asc) as account_rank from {{Union}}
      ids:
        - select: "company_domain_c"
          type: domain
          entity: account
          to_default_stitcher: false
        - select: "context_traits_email"
          type: email
          entity: user
          to_default_stitcher: false
      contract:
        is_optional: false
        is_event_stream: false
        with_entity_ids:
          - account
          - user
        with_columns:
          - name: company_domain_c
          - name: context_traits_email